<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Inferring borrow kinds for upvars"><title>rustc_hir_typeck::upvar - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-49344e4802b2d48a.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="rustc_hir_typeck" data-themes="" data-resource-suffix="" data-rustdoc-version="1.83.0-dev" data-channel="nightly" data-search-js="search-e056c65ede92db13.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../rustc_hir_typeck/index.html">rustc_<wbr>hir_<wbr>typeck</a><span class="version">1.83.0-dev</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module upvar</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#inferring-borrow-kinds-for-upvars" title="Inferring borrow kinds for upvars">Inferring borrow kinds for upvars</a></li></ul><h3><a href="#structs">Module Items</a></h3><ul class="block"><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#functions" title="Functions">Functions</a></li><li><a href="#types" title="Type Aliases">Type Aliases</a></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="../index.html">In crate rustc_<wbr>hir_<wbr>typeck</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../index.html">rustc_hir_typeck</a></span><h1>Module <span>upvar</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/rustc_hir_typeck/upvar.rs.html#1-2482">source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h4 id="inferring-borrow-kinds-for-upvars"><a class="doc-anchor" href="#inferring-borrow-kinds-for-upvars">§</a>Inferring borrow kinds for upvars</h4>
<p>Whenever there is a closure expression, we need to determine how each
upvar is used. We do this by initially assigning each upvar an
immutable “borrow kind” (see <code>ty::BorrowKind</code> for details) and then
“escalating” the kind as needed. The borrow kind proceeds according to
the following lattice:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>ty::ImmBorrow -&gt; ty::UniqueImmBorrow -&gt; ty::MutBorrow</code></pre></div>
<p>So, for example, if we see an assignment <code>x = 5</code> to an upvar <code>x</code>, we
will promote its borrow kind to mutable borrow. If we see an <code>&amp;mut x</code>
we’ll do the same. Naturally, this applies not just to the upvar, but
to everything owned by <code>x</code>, so the result is the same for something
like <code>x.f = 5</code> and so on (presuming <code>x</code> is not a borrowed pointer to a
struct). These adjustments are performed in
<code>adjust_upvar_borrow_kind()</code> (you can trace backwards through the code
from there).</p>
<p>The fact that we are inferring borrow kinds as we go results in a
semi-hacky interaction with mem-categorization. In particular,
mem-categorization will query the current borrow kind as it
categorizes, and we’ll return the <em>current</em> value, but this may get
adjusted later. Therefore, in this module, we generally ignore the
borrow kind (and derived mutabilities) that are returned from
mem-categorization, since they may be inaccurate. (Another option
would be to use a unification scheme, where instead of returning a
concrete borrow kind like <code>ty::ImmBorrow</code>, we return a
<code>ty::InferBorrow(upvar_id)</code> or something like that, but this would
then mean that all later passes would have to check for these figments
and report an error, and it just seems like more mess in the end.)</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.InferBorrowKind.html" title="struct rustc_hir_typeck::upvar::InferBorrowKind">Infer<wbr>Borrow<wbr>Kind</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="struct" href="struct.InferBorrowKindVisitor.html" title="struct rustc_hir_typeck::upvar::InferBorrowKindVisitor">Infer<wbr>Borrow<wbr>Kind<wbr>Visitor</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="struct" href="struct.MigrationLintNote.html" title="struct rustc_hir_typeck::upvar::MigrationLintNote">Migration<wbr>Lint<wbr>Note</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Intermediate format to store information needed to generate a note in the migration lint.</div></li><li><div class="item-name"><a class="struct" href="struct.MigrationWarningReason.html" title="struct rustc_hir_typeck::upvar::MigrationWarningReason">Migration<wbr>Warning<wbr>Reason</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Reasons that we might issue a migration warning.</div></li><li><div class="item-name"><a class="struct" href="struct.NeededMigration.html" title="struct rustc_hir_typeck::upvar::NeededMigration">Needed<wbr>Migration</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Intermediate format to store the hir id of the root variable and a HashSet containing
information on why the root variable should be fully captured</div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.PlaceAncestryRelation.html" title="enum rustc_hir_typeck::upvar::PlaceAncestryRelation">Place<wbr>Ancestry<wbr>Relation</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Describe the relationship between the paths of two places
eg:</div></li><li><div class="item-name"><a class="enum" href="enum.UpvarMigrationInfo.html" title="enum rustc_hir_typeck::upvar::UpvarMigrationInfo">Upvar<wbr>Migration<wbr>Info</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Intermediate format to store the hir_id pointing to the use that resulted in the
corresponding place being captured and a String which contains the captured value’s
name (i.e: a.b.c)</div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.adjust_for_move_closure.html" title="fn rustc_hir_typeck::upvar::adjust_for_move_closure">adjust_<wbr>for_<wbr>move_<wbr>closure</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Truncate deref of any reference.</div></li><li><div class="item-name"><a class="fn" href="fn.adjust_for_non_move_closure.html" title="fn rustc_hir_typeck::upvar::adjust_for_non_move_closure">adjust_<wbr>for_<wbr>non_<wbr>move_<wbr>closure</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Adjust closure capture just that if taking ownership of data, only move data
from enclosing stack frame.</div></li><li><div class="item-name"><a class="fn" href="fn.apply_capture_kind_on_capture_ty.html" title="fn rustc_hir_typeck::upvar::apply_capture_kind_on_capture_ty">apply_<wbr>capture_<wbr>kind_<wbr>on_<wbr>capture_<wbr>ty</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Returns a Ty that applies the specified capture kind on the provided capture Ty</div></li><li><div class="item-name"><a class="fn" href="fn.construct_capture_info_string.html" title="fn rustc_hir_typeck::upvar::construct_capture_info_string">construct_<wbr>capture_<wbr>info_<wbr>string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.construct_capture_kind_reason_string.html" title="fn rustc_hir_typeck::upvar::construct_capture_kind_reason_string">construct_<wbr>capture_<wbr>kind_<wbr>reason_<wbr>string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.construct_path_string.html" title="fn rustc_hir_typeck::upvar::construct_path_string">construct_<wbr>path_<wbr>string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.construct_place_string.html" title="fn rustc_hir_typeck::upvar::construct_place_string">construct_<wbr>place_<wbr>string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.determine_capture_info.html" title="fn rustc_hir_typeck::upvar::determine_capture_info">determine_<wbr>capture_<wbr>info</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Helper function to determine if we need to escalate CaptureKind from
CaptureInfo A to B and returns the escalated CaptureInfo.
(Note: CaptureInfo contains CaptureKind and an expression that led to capture it in that way)</div></li><li><div class="item-name"><a class="fn" href="fn.determine_place_ancestry_relation.html" title="fn rustc_hir_typeck::upvar::determine_place_ancestry_relation">determine_<wbr>place_<wbr>ancestry_<wbr>relation</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Determines the Ancestry relationship of Place A relative to Place B</div></li><li><div class="item-name"><a class="fn" href="fn.drop_location_span.html" title="fn rustc_hir_typeck::upvar::drop_location_span">drop_<wbr>location_<wbr>span</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Returns the Span of where the value with the provided HirId would be dropped</div></li><li><div class="item-name"><a class="fn" href="fn.enable_precise_capture.html" title="fn rustc_hir_typeck::upvar::enable_precise_capture">enable_<wbr>precise_<wbr>capture</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Precise capture is enabled if user is using Rust Edition 2021 or higher.
<code>span</code> is the span of the closure.</div></li><li><div class="item-name"><a class="fn" href="fn.migration_suggestion_for_2229.html" title="fn rustc_hir_typeck::upvar::migration_suggestion_for_2229">migration_<wbr>suggestion_<wbr>for_<wbr>2229</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Return a two string tuple (s1, s2)</div></li><li><div class="item-name"><a class="fn" href="fn.restrict_capture_precision.html" title="fn rustc_hir_typeck::upvar::restrict_capture_precision">restrict_<wbr>capture_<wbr>precision</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Truncate projections so that following rules are obeyed by the captured <code>place</code>:</div></li><li><div class="item-name"><a class="fn" href="fn.restrict_precision_for_drop_types.html" title="fn rustc_hir_typeck::upvar::restrict_precision_for_drop_types">restrict_<wbr>precision_<wbr>for_<wbr>drop_<wbr>types</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Rust doesn’t permit moving fields out of a type that implements drop</div></li><li><div class="item-name"><a class="fn" href="fn.restrict_precision_for_unsafe.html" title="fn rustc_hir_typeck::upvar::restrict_precision_for_unsafe">restrict_<wbr>precision_<wbr>for_<wbr>unsafe</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Truncate <code>place</code> so that an <code>unsafe</code> block isn’t required to capture it.</div></li><li><div class="item-name"><a class="fn" href="fn.restrict_repr_packed_field_ref_capture.html" title="fn rustc_hir_typeck::upvar::restrict_repr_packed_field_ref_capture">restrict_<wbr>repr_<wbr>packed_<wbr>field_<wbr>ref_<wbr>capture</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Truncate the capture so that the place being borrowed is in accordance with RFC 1240,
which states that it’s unsafe to take a reference into a struct marked <code>repr(packed)</code>.</div></li><li><div class="item-name"><a class="fn" href="fn.should_do_rust_2021_incompatible_closure_captures_analysis.html" title="fn rustc_hir_typeck::upvar::should_do_rust_2021_incompatible_closure_captures_analysis">should_<wbr>do_<wbr>rust_<wbr>2021_<wbr>incompatible_<wbr>closure_<wbr>captures_<wbr>analysis</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.should_reborrow_from_env_of_parent_coroutine_closure.html" title="fn rustc_hir_typeck::upvar::should_reborrow_from_env_of_parent_coroutine_closure">should_<wbr>reborrow_<wbr>from_<wbr>env_<wbr>of_<wbr>parent_<wbr>coroutine_<wbr>closure</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Determines whether a child capture that is derived from a parent capture
should be borrowed with the lifetime of the parent coroutine-closure’s env.</div></li><li><div class="item-name"><a class="fn" href="fn.truncate_capture_for_optimization.html" title="fn rustc_hir_typeck::upvar::truncate_capture_for_optimization">truncate_<wbr>capture_<wbr>for_<wbr>optimization</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Reduces the precision of the captured place when the precision doesn’t yield any benefit from
borrow checking perspective, allowing us to save us on the size of the capture.</div></li><li><div class="item-name"><a class="fn" href="fn.truncate_place_to_len_and_update_capture_kind.html" title="fn rustc_hir_typeck::upvar::truncate_place_to_len_and_update_capture_kind">truncate_<wbr>place_<wbr>to_<wbr>len_<wbr>and_<wbr>update_<wbr>capture_<wbr>kind</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Truncates <code>place</code> to have up to <code>len</code> projections.
<code>curr_mode</code> is the current required capture kind for the place.
Returns the truncated <code>place</code> and the updated required capture kind.</div></li><li><div class="item-name"><a class="fn" href="fn.var_name.html" title="fn rustc_hir_typeck::upvar::var_name">var_<wbr>name</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="type" href="type.InferredCaptureInformation.html" title="type rustc_hir_typeck::upvar::InferredCaptureInformation">Inferred<wbr>Capture<wbr>Information</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Intermediate format to store a captured <code>Place</code> and associated <code>ty::CaptureInfo</code>
during capture analysis. Information in this map feeds into the minimum capture
analysis pass.</div></li></ul></section></div></main></body></html>