<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Managing the scope stack. The scopes are tied to lexical scopes, so as we descend the THIR, we push a scope on the stack, build its contents, and then pop it off. Every scope is named by a `region::Scope`."><title>rustc_mir_build::build::scope - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-49344e4802b2d48a.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_mir_build" data-themes="" data-resource-suffix="" data-rustdoc-version="1.83.0-dev" data-channel="nightly" data-search-js="search-e056c65ede92db13.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../../../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../rustc_mir_build/index.html">rustc_<wbr>mir_<wbr>build</a><span class="version">1.83.0-dev</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module scope</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#seme-regions" title="SEME Regions">SEME Regions</a></li><li><a href="#not-so-seme-regions" title="Not so SEME Regions">Not so SEME Regions</a></li><li><a href="#drops" title="Drops">Drops</a></li><li><a href="#early-exit" title="Early exit">Early exit</a></li><li><a href="#breakable-scopes" title="Breakable scopes">Breakable scopes</a></li></ul><h3><a href="#structs">Module Items</a></h3><ul class="block"><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#constants" title="Constants">Constants</a></li><li><a href="#traits" title="Traits">Traits</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In rustc_<wbr>mir_<wbr>build::<wbr>build</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../../index.html">rustc_mir_build</a>::<wbr><a href="../index.html">build</a></span><h1>Module <span>scope</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/rustc_mir_build/build/scope.rs.html#1-1604">source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Managing the scope stack. The scopes are tied to lexical scopes, so as
we descend the THIR, we push a scope on the stack, build its
contents, and then pop it off. Every scope is named by a
<code>region::Scope</code>.</p>
<h4 id="seme-regions"><a class="doc-anchor" href="#seme-regions">¬ß</a>SEME Regions</h4>
<p>When pushing a new <a href="struct.Scope.html" title="struct rustc_mir_build::build::scope::Scope">Scope</a>, we record the current point in the graph (a
basic block); this marks the entry to the scope. We then generate more
stuff in the control-flow graph. Whenever the scope is exited, either
via a <code>break</code> or <code>return</code> or just by fallthrough, that marks an exit
from the scope. Each lexical scope thus corresponds to a single-entry,
multiple-exit (SEME) region in the control-flow graph.</p>
<p>For now, we record the <code>region::Scope</code> to each SEME region for later reference
(see caveat in next paragraph). This is because destruction scopes are tied to
them. This may change in the future so that MIR lowering determines its own
destruction scopes.</p>
<h4 id="not-so-seme-regions"><a class="doc-anchor" href="#not-so-seme-regions">¬ß</a>Not so SEME Regions</h4>
<p>In the course of building matches, it sometimes happens that certain code
(namely guards) gets executed multiple times. This means that the scope lexical
scope may in fact correspond to multiple, disjoint SEME regions. So in fact our
mapping is from one scope to a vector of SEME regions. Since the SEME regions
are disjoint, the mapping is still one-to-one for the set of SEME regions that
we‚Äôre currently in.</p>
<p>Also in matches, the scopes assigned to arms are not always even SEME regions!
Each arm has a single region with one entry for each pattern. We manually
manipulate the scheduled drops in this scope to avoid dropping things multiple
times.</p>
<h4 id="drops"><a class="doc-anchor" href="#drops">¬ß</a>Drops</h4>
<p>The primary purpose for scopes is to insert drops: while building
the contents, we also accumulate places that need to be dropped upon
exit from each scope. This is done by calling <code>schedule_drop</code>. Once a
drop is scheduled, whenever we branch out we will insert drops of all
those places onto the outgoing edge. Note that we don‚Äôt know the full
set of scheduled drops up front, and so whenever we exit from the
scope we only drop the values scheduled thus far. For example, consider
the scope S corresponding to this loop:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">loop </span>{
    <span class="kw">let </span>x = ..;
    <span class="kw">if </span>cond { <span class="kw">break</span>; }
    <span class="kw">let </span>y = ..;
}</code></pre></div>
<p>When processing the <code>let x</code>, we will add one drop to the scope for
<code>x</code>. The break will then insert a drop for <code>x</code>. When we process <code>let y</code>, we will add another drop (in fact, to a subscope, but let‚Äôs ignore
that for now); any later drops would also drop <code>y</code>.</p>
<h4 id="early-exit"><a class="doc-anchor" href="#early-exit">¬ß</a>Early exit</h4>
<p>There are numerous ‚Äúnormal‚Äù ways to early exit a scope: <code>break</code>,
<code>continue</code>, <code>return</code> (panics are handled separately). Whenever an
early exit occurs, the method <code>break_scope</code> is called. It is given the
current point in execution where the early exit occurs, as well as the
scope you want to branch to (note that all early exits from to some
other enclosing scope). <code>break_scope</code> will record the set of drops currently
scheduled in a <a href="struct.DropTree.html" title="struct rustc_mir_build::build::scope::DropTree">DropTree</a>. Later, before <code>in_breakable_scope</code> exits, the drops
will be added to the CFG.</p>
<p>Panics are handled in a similar fashion, except that the drops are added to the
MIR once the rest of the function has finished being lowered. If a terminator
can panic, call <code>diverge_from(block)</code> with the block containing the terminator
<code>block</code>.</p>
<h4 id="breakable-scopes"><a class="doc-anchor" href="#breakable-scopes">¬ß</a>Breakable scopes</h4>
<p>In addition to the normal scope stack, we track a loop scope stack
that contains only loops and breakable blocks. It tracks where a <code>break</code>,
<code>continue</code> or <code>return</code> should go to.</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.BreakableScope.html" title="struct rustc_mir_build::build::scope::BreakableScope">Breakable<wbr>Scope</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.CoroutineDrop.html" title="struct rustc_mir_build::build::scope::CoroutineDrop">Coroutine<wbr>Drop</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.DropData.html" title="struct rustc_mir_build::build::scope::DropData">Drop<wbr>Data</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.DropIdx.html" title="struct rustc_mir_build::build::scope::DropIdx">DropIdx</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.DropNode.html" title="struct rustc_mir_build::build::scope::DropNode">Drop<wbr>Node</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">A single node in the drop tree.</div></li><li><div class="item-name"><a class="struct" href="struct.DropNodeKey.html" title="struct rustc_mir_build::build::scope::DropNodeKey">Drop<wbr>Node<wbr>Key</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Subset of <a href="struct.DropNode.html" title="struct rustc_mir_build::build::scope::DropNode"><code>DropNode</code></a> used for reverse lookup in a hash table.</div></li><li><div class="item-name"><a class="struct" href="struct.DropTree.html" title="struct rustc_mir_build::build::scope::DropTree">Drop<wbr>Tree</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">A tree of drops that we have deferred lowering. It‚Äôs used for:</div></li><li><div class="item-name"><a class="struct" href="struct.ExitScopes.html" title="struct rustc_mir_build::build::scope::ExitScopes">Exit<wbr>Scopes</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.IfThenScope.html" title="struct rustc_mir_build::build::scope::IfThenScope">IfThen<wbr>Scope</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.Scope.html" title="struct rustc_mir_build::build::scope::Scope">Scope</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.Scopes.html" title="struct rustc_mir_build::build::scope::Scopes">Scopes</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="struct" href="struct.Unwind.html" title="struct rustc_mir_build::build::scope::Unwind">Unwind</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.BreakableTarget.html" title="enum rustc_mir_build::build::scope::BreakableTarget">Breakable<wbr>Target</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">The target of an expression that breaks out of a scope</div></li><li><div class="item-name"><a class="enum" href="enum.DropKind.html" title="enum rustc_mir_build::build::scope::DropKind">Drop<wbr>Kind</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.ROOT_NODE.html" title="constant rustc_mir_build::build::scope::ROOT_NODE">ROOT_<wbr>NODE</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.DropTreeBuilder.html" title="trait rustc_mir_build::build::scope::DropTreeBuilder">Drop<wbr>Tree<wbr>Builder</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">A trait that determined how <a href="struct.DropTree.html" title="struct rustc_mir_build::build::scope::DropTree">DropTree</a> creates its blocks and
links to any entry nodes.</div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.build_scope_drops.html" title="fn rustc_mir_build::build::scope::build_scope_drops">build_<wbr>scope_<wbr>drops</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Builds drops for <code>pop_scope</code> and <code>leave_top_scope</code>.</div></li></ul></section></div></main></body></html>