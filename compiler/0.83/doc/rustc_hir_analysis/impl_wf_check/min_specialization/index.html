<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Minimal Specialization"><title>rustc_hir_analysis::impl_wf_check::min_specialization - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-49344e4802b2d48a.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_hir_analysis" data-themes="" data-resource-suffix="" data-rustdoc-version="1.83.0-dev" data-channel="nightly" data-search-js="search-e056c65ede92db13.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../../../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button><a class="logo-container" href="../../../rustc_hir_analysis/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt=""></a></nav><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../../../rustc_hir_analysis/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2><a href="../../../rustc_hir_analysis/index.html">rustc_<wbr>hir_<wbr>analysis</a><span class="version">1.83.0-dev</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module min_<wbr>specialization</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#minimal-specialization" title="Minimal Specialization">Minimal Specialization</a><ul><li><a href="#basic-approach" title="Basic approach">Basic approach</a></li><li><a href="#example" title="Example">Example</a></li><li><a href="#extensions" title="Extensions">Extensions</a></li></ul></li></ul><h3><a href="#functions">Module Items</a></h3><ul class="block"><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In rustc_<wbr>hir_<wbr>analysis::<wbr>impl_<wbr>wf_<wbr>check</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../../index.html">rustc_hir_analysis</a>::<wbr><a href="../index.html">impl_wf_check</a></span><h1>Module <span>min_specialization</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/rustc_hir_analysis/impl_wf_check/min_specialization.rs.html#1-535">source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="minimal-specialization"><a class="doc-anchor" href="#minimal-specialization">§</a>Minimal Specialization</h2>
<p>This module contains the checks for sound specialization used when the
<code>min_specialization</code> feature is enabled. This requires that the impl is
<em>always applicable</em>.</p>
<p>If <code>impl1</code> specializes <code>impl2</code> then <code>impl1</code> is always applicable if we know
that all the bounds of <code>impl2</code> are satisfied, and all of the bounds of
<code>impl1</code> are satisfied for some choice of lifetimes then we know that
<code>impl1</code> applies for any choice of lifetimes.</p>
<h3 id="basic-approach"><a class="doc-anchor" href="#basic-approach">§</a>Basic approach</h3>
<p>To enforce this requirement on specializations we take the following
approach:</p>
<ol>
<li>Match up the args for <code>impl2</code> so that the implemented trait and
self-type match those for <code>impl1</code>.</li>
<li>Check for any direct use of <code>'static</code> in the args of <code>impl2</code>.</li>
<li>Check that all of the generic parameters of <code>impl1</code> occur at most once
in the <em>unconstrained</em> args for <code>impl2</code>. A parameter is constrained if
its value is completely determined by an associated type projection
predicate.</li>
<li>Check that all predicates on <code>impl1</code> either exist on <code>impl2</code> (after
matching args), or are well-formed predicates for the trait’s type
arguments.</li>
</ol>
<h3 id="example"><a class="doc-anchor" href="#example">§</a>Example</h3>
<p>Suppose we have the following always applicable impl:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code><span class="kw">impl</span>&lt;T&gt; SpecExtend&lt;T&gt; <span class="kw">for </span>std::vec::IntoIter&lt;T&gt; { <span class="comment">/* specialized impl */ </span>}
<span class="kw">impl</span>&lt;T, I: Iterator&lt;Item=T&gt;&gt; SpecExtend&lt;T&gt; <span class="kw">for </span>I { <span class="comment">/* default impl */ </span>}</code></pre></div>
<p>We get that the generic pamameters for <code>impl2</code> are <code>[T, std::vec::IntoIter&lt;T&gt;]</code>.
<code>T</code> is constrained to be <code>&lt;I as Iterator&gt;::Item</code>, so we check only
<code>std::vec::IntoIter&lt;T&gt;</code> for repeated parameters, which it doesn’t have. The
predicates of <code>impl1</code> are only <code>T: Sized</code>, which is also a predicate of
<code>impl2</code>. So this specialization is sound.</p>
<h3 id="extensions"><a class="doc-anchor" href="#extensions">§</a>Extensions</h3>
<p>Unfortunately not all specializations in the standard library are allowed
by this. So there are two extensions to these rules that allow specializing
on some traits: that is, using them as bounds on the specializing impl,
even when they don’t occur in the base impl.</p>
<h4 id="rustc_specialization_trait"><a class="doc-anchor" href="#rustc_specialization_trait">§</a>rustc_specialization_trait</h4>
<p>If a trait is always applicable, then it’s sound to specialize on it. We
check trait is always applicable in the same way as impls, except that step
4 is now “all predicates on <code>impl1</code> are always applicable”. We require that
<code>specialization</code> or <code>min_specialization</code> is enabled to implement these
traits.</p>
<h4 id="rustc_unsafe_specialization_marker"><a class="doc-anchor" href="#rustc_unsafe_specialization_marker">§</a>rustc_unsafe_specialization_marker</h4>
<p>There are also some specialization on traits with no methods, including the
stable <code>FusedIterator</code> trait. We allow marking marker traits with an
unstable attribute that means we ignore them in point 3 of the checks
above. This is unsound, in the sense that the specialized impl may be used
when it doesn’t apply, but we allow it in the short term since it can’t
cause use after frees with purely safe code in the same way as specializing
on traits with methods can.</p>
</div></details><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.check_always_applicable.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_always_applicable">check_<wbr>always_<wbr>applicable</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Check that <code>impl1</code> is a sound specialization</div></li><li><div class="item-name"><a class="fn" href="fn.check_constness.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_constness">check_<wbr>constness</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Check that the specializing impl <code>impl1</code> is at least as const as the base
impl <code>impl2</code></div></li><li><div class="item-name"><a class="fn" href="fn.check_duplicate_params.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_duplicate_params">check_<wbr>duplicate_<wbr>params</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Check that parameters of the derived impl don’t occur more than once in the
equated args of the base impl.</div></li><li><div class="item-name"><a class="fn" href="fn.check_has_items.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_has_items">check_<wbr>has_<wbr>items</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_min_specialization.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_min_specialization">check_<wbr>min_<wbr>specialization</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_predicates.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_predicates">check_<wbr>predicates</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Check whether predicates on the specializing impl (<code>impl1</code>) are allowed.</div></li><li><div class="item-name"><a class="fn" href="fn.check_specialization_on.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_specialization_on">check_<wbr>specialization_<wbr>on</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_static_lifetimes.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_static_lifetimes">check_<wbr>static_<wbr>lifetimes</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Check that <code>'static</code> lifetimes are not introduced by the specializing impl.</div></li><li><div class="item-name"><a class="fn" href="fn.get_impl_args.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::get_impl_args">get_<wbr>impl_<wbr>args</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Given a specializing impl <code>impl1</code>, and the base impl <code>impl2</code>, returns two
generic parameters <code>(S1, S2)</code> that equate their trait references.
The returned types are expressed in terms of the generics of <code>impl1</code>.</div></li><li><div class="item-name"><a class="fn" href="fn.parent_specialization_node.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::parent_specialization_node">parent_<wbr>specialization_<wbr>node</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.trait_predicates_eq.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::trait_predicates_eq">trait_<wbr>predicates_<wbr>eq</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Checks if some predicate on the specializing impl (<code>predicate1</code>) is the same
as some predicate on the base impl (<code>predicate2</code>).</div></li><li><div class="item-name"><a class="fn" href="fn.trait_specialization_kind.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::trait_specialization_kind">trait_<wbr>specialization_<wbr>kind</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.unconstrained_parent_impl_args.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::unconstrained_parent_impl_args">unconstrained_<wbr>parent_<wbr>impl_<wbr>args</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Returns a list of all of the unconstrained generic parameters of the given impl.</div></li></ul></section></div></main></body></html>