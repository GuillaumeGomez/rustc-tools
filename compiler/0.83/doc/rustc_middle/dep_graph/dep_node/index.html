<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Nodes in the dependency graph."><title>rustc_middle::dep_graph::dep_node - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-49344e4802b2d48a.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_middle" data-themes="" data-resource-suffix="" data-rustdoc-version="1.83.0-dev" data-channel="nightly" data-search-js="search-e056c65ede92db13.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../../../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button><a class="logo-container" href="../../../rustc_middle/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt=""></a></nav><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../../../rustc_middle/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2><a href="../../../rustc_middle/index.html">rustc_<wbr>middle</a><span class="version">1.83.0-dev</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module dep_<wbr>node</a></h2><h3><a href="#modules">Module Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#macros" title="Macros">Macros</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#constants" title="Constants">Constants</a></li><li><a href="#traits" title="Traits">Traits</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In rustc_<wbr>middle::<wbr>dep_<wbr>graph</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../../index.html">rustc_middle</a>::<wbr><a href="../index.html">dep_graph</a></span><h1>Module <span>dep_node</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/rustc_middle/dep_graph/dep_node.rs.html#1-450">source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Nodes in the dependency graph.</p>
<p>A node in the <a href="https://rustc-dev-guide.rust-lang.org/query.html">dependency graph</a> is represented by a <a href="../struct.DepNode.html" title="struct rustc_middle::dep_graph::DepNode"><code>DepNode</code></a>.
A <code>DepNode</code> consists of a <a href="../struct.DepKind.html" title="struct rustc_middle::dep_graph::DepKind"><code>DepKind</code></a> (which
specifies the kind of thing it represents, like a piece of HIR, MIR, etc.)
and a <a href="../../../rustc_data_structures/fingerprint/struct.Fingerprint.html" title="struct rustc_data_structures::fingerprint::Fingerprint"><code>Fingerprint</code></a>, a 128-bit hash value, the exact meaning of which
depends on the node‚Äôs <code>DepKind</code>. Together, the kind and the fingerprint
fully identify a dependency node, even across multiple compilation sessions.
In other words, the value of the fingerprint does not depend on anything
that is specific to a given compilation session, like an unpredictable
interning key (e.g., <code>NodeId</code>, <code>DefId</code>, <code>Symbol</code>) or the numeric value of a
pointer. The concept behind this could be compared to how git commit hashes
uniquely identify a given commit. The fingerprinting approach has
a few advantages:</p>
<ul>
<li>A <code>DepNode</code> can simply be serialized to disk and loaded in another session
without the need to do any ‚Äúrebasing‚Äù (like we have to do for Spans and
NodeIds) or ‚Äúretracing‚Äù (like we had to do for <code>DefId</code> in earlier
implementations of the dependency graph).</li>
<li>A <code>Fingerprint</code> is just a bunch of bits, which allows <code>DepNode</code> to
implement <code>Copy</code>, <code>Sync</code>, <code>Send</code>, <code>Freeze</code>, etc.</li>
<li>Since we just have a bit pattern, <code>DepNode</code> can be mapped from disk into
memory without any post-processing (e.g., ‚Äúabomination-style‚Äù pointer
reconstruction).</li>
<li>Because a <code>DepNode</code> is self-contained, we can instantiate <code>DepNodes</code> that
refer to things that do not exist anymore. In previous implementations
<code>DepNode</code> contained a <code>DefId</code>. A <code>DepNode</code> referring to something that
had been removed between the previous and the current compilation session
could not be instantiated because the current compilation session
contained no <code>DefId</code> for thing that had been removed.</li>
</ul>
<p><code>DepNode</code> definition happens in the <code>define_dep_nodes!()</code> macro. This macro
defines the <code>DepKind</code> enum. Each <code>DepKind</code> has its own parameters that are
needed at runtime in order to construct a valid <code>DepNode</code> fingerprint.
However, only <code>CompileCodegenUnit</code> and <code>CompileMonoItem</code> are constructed
explicitly (with <code>make_compile_codegen_unit</code> cq <code>make_compile_mono_item</code>).</p>
<p>Because the macro sees what parameters a given <code>DepKind</code> requires, it can
‚Äúinfer‚Äù some properties for each kind of <code>DepNode</code>:</p>
<ul>
<li>Whether a <code>DepNode</code> of a given kind has any parameters at all. Some
<code>DepNode</code>s could represent global concepts with only one value.</li>
<li>Whether it is possible, in principle, to reconstruct a query key from a
given <code>DepNode</code>. Many <code>DepKind</code>s only require a single <code>DefId</code> parameter,
in which case it is possible to map the node‚Äôs fingerprint back to the
<code>DefId</code> it was computed from. In other cases, too much information gets
lost during fingerprint computation.</li>
</ul>
<p><code>make_compile_codegen_unit</code> and <code>make_compile_mono_items</code>, together with
<code>DepNode::new()</code>, ensures that only valid <code>DepNode</code> instances can be
constructed. For example, the API does not allow for constructing
parameterless <code>DepNode</code>s with anything other than a zeroed out fingerprint.
More generally speaking, it relieves the user of the <code>DepNode</code> API of
having to know how to compute the expected fingerprint for a given set of
node parameters.</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="dep_kinds/index.html" title="mod rustc_middle::dep_graph::dep_node::dep_kinds">dep_<wbr>kinds</a></div></li><li><div class="item-name"><a class="mod" href="label_strs/index.html" title="mod rustc_middle::dep_graph::dep_node::label_strs">label_<wbr>strs</a></div><div class="desc docblock-short">Contains variant =&gt; str representations for constructing
DepNode groups for tests.</div></li></ul><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.define_dep_nodes.html" title="macro rustc_middle::dep_graph::dep_node::define_dep_nodes">define_<wbr>dep_<wbr>nodes</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="macro" href="macro.impl_for_typed_def_id.html" title="macro rustc_middle::dep_graph::dep_node::impl_for_typed_def_id">impl_<wbr>for_<wbr>typed_<wbr>def_<wbr>id</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.DepKind.html" title="struct rustc_middle::dep_graph::dep_node::DepKind">DepKind</a></div><div class="desc docblock-short">This serves as an index into arrays built by <code>make_dep_kind_array</code>.</div></li><li><div class="item-name"><a class="struct" href="struct.DepNode.html" title="struct rustc_middle::dep_graph::dep_node::DepNode">DepNode</a></div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.DepKindDefs.html" title="enum rustc_middle::dep_graph::dep_node::DepKindDefs">DepKind<wbr>Defs</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">This enum serves as an index into arrays built by <code>make_dep_kind_array</code>.</div></li></ul><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.DEP_KIND_VARIANTS.html" title="constant rustc_middle::dep_graph::dep_node::DEP_KIND_VARIANTS">DEP_<wbr>KIND_<wbr>VARIANTS</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.DepContext.html" title="trait rustc_middle::dep_graph::dep_node::DepContext">DepContext</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="trait" href="trait.DepNodeExt.html" title="trait rustc_middle::dep_graph::dep_node::DepNodeExt">DepNode<wbr>Ext</a></div></li><li><div class="item-name"><a class="trait" href="trait.DepNodeParams.html" title="trait rustc_middle::dep_graph::dep_node::DepNodeParams">DepNode<wbr>Params</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">¬ß</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.dep_kind_from_label_string.html" title="fn rustc_middle::dep_graph::dep_node::dep_kind_from_label_string">dep_<wbr>kind_<wbr>from_<wbr>label_<wbr>string</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.make_compile_codegen_unit.html" title="fn rustc_middle::dep_graph::dep_node::make_compile_codegen_unit">make_<wbr>compile_<wbr>codegen_<wbr>unit</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.make_compile_mono_item.html" title="fn rustc_middle::dep_graph::dep_node::make_compile_mono_item">make_<wbr>compile_<wbr>mono_<wbr>item</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul></section></div></main></body></html>