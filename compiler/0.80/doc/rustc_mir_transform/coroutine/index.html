<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This is the implementation of the pass which transforms coroutines into state machines."><title>rustc_mir_transform::coroutine - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-5ca6ca2a1f83705a.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="rustc_mir_transform" data-themes="" data-resource-suffix="" data-rustdoc-version="1.82.0-dev" data-channel="nightly" data-search-js="search-d234aafac6c221dd.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-d2fab2bf619172d3.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../rustc_mir_transform/index.html">rustc_mir_transform</a><span class="version">1.82.0-dev</span></h2></div><h2 class="location"><a href="#">Module coroutine</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#reexports">Re-exports</a></li><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li></ul></section><h2><a href="../index.html">In crate rustc_mir_transform</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">rustc_mir_transform</a>::<wbr><a class="mod" href="#">coroutine</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../src/rustc_mir_transform/coroutine.rs.html#1-2137">source</a> Â· <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This is the implementation of the pass which transforms coroutines into state machines.</p>
<p>MIR generation for coroutines creates a function which has a self argument which
passes by value. This argument is effectively a coroutine type which only contains upvars and
is only used for this argument inside the MIR for the coroutine.
It is passed by value to enable upvars to be moved out of it. Drop elaboration runs on that
MIR before this pass and creates drop flags for MIR locals.
It will also drop the coroutine argument (which only consists of upvars) if any of the upvars
are moved out of. This pass elaborates the drops of upvars / coroutine argument in the case
that none of the upvars were moved out of. This is because we cannot have any drops of this
coroutine in the MIR, since it is used to create the drop glue for the coroutine. Weâ€™d get
infinite recursion otherwise.</p>
<p>This pass creates the implementation for either the <code>Coroutine::resume</code> or <code>Future::poll</code>
function and the drop shim for the coroutine based on the MIR input.
It converts the coroutine argument from Self to &amp;mut Self adding derefs in the MIR as needed.
It computes the final layout of the coroutine struct which looks like this:
First upvars are stored
It is followed by the coroutine state field.
Then finally the MIR locals which are live across a suspension point are stored.
<code>ignore (illustrative)     struct Coroutine {         upvars...,         state: u32,         mir_locals...,     }     </code>
This pass computes the meaning of the state field and the MIR locals which are live
across a suspension point. There are however three hardcoded coroutine states:
0 - Coroutine have not been resumed yet
1 - Coroutine has returned / is completed
2 - Coroutine has been poisoned</p>
<p>It also rewrites <code>return x</code> and <code>yield y</code> as setting a new coroutine state and returning
<code>CoroutineState::Complete(x)</code> and <code>CoroutineState::Yielded(y)</code>,
or <code>Poll::Ready(x)</code> and <code>Poll::Pending</code> respectively.
MIR locals which are live across a suspension point are moved to the coroutine struct
with references to them being updated with references to the coroutine struct.</p>
<p>The pass creates two functions which have a switch on the coroutine state giving
the action to take.</p>
<p>One of them is the implementation of <code>Coroutine::resume</code> / <code>Future::poll</code>.
For coroutines with state 0 (unresumed) it starts the execution of the coroutine.
For coroutines with state 1 (returned) and state 2 (poisoned) it panics.
Otherwise it continues the execution from the last suspension point.</p>
<p>The other function is the drop glue for the coroutine.
For coroutines with state 0 (unresumed) it drops the upvars of the coroutine.
For coroutines with state 1 (returned) and state 2 (poisoned) it does nothing.
Otherwise it drops all the values in scope at the last suspension point.</p>
</div></details><h2 id="reexports" class="section-header">Re-exports<a href="#reexports" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name" id="reexport.ByMoveBody"><code>pub use by_move_body::<a class="struct" href="by_move_body/struct.ByMoveBody.html" title="struct rustc_mir_transform::coroutine::by_move_body::ByMoveBody">ByMoveBody</a>;</code></div></li></ul><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="by_move_body/index.html" title="mod rustc_mir_transform::coroutine::by_move_body">by_move_body</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">This pass constructs a second coroutine body sufficient for return from
<code>FnOnce</code>/<code>AsyncFnOnce</code> implementations for coroutine-closures (e.g. async closures).</div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.CoroutineSavedLocals.html" title="struct rustc_mir_transform::coroutine::CoroutineSavedLocals">CoroutineSavedLocals</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">The set of <code>Local</code>s that must be saved across yield points.</div></li><li><div class="item-name"><a class="struct" href="struct.DerefArgVisitor.html" title="struct rustc_mir_transform::coroutine::DerefArgVisitor">DerefArgVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.EnsureCoroutineFieldAssignmentsNeverAlias.html" title="struct rustc_mir_transform::coroutine::EnsureCoroutineFieldAssignmentsNeverAlias">EnsureCoroutineFieldAssignmentsNeverAlias</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Looks for any assignments between locals (e.g., <code>_4 = _5</code>) that will both be converted to fields
in the coroutine state machine but whose storage is not marked as conflicting</div></li><li><div class="item-name"><a class="struct" href="struct.LivenessInfo.html" title="struct rustc_mir_transform::coroutine::LivenessInfo">LivenessInfo</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.PinArgVisitor.html" title="struct rustc_mir_transform::coroutine::PinArgVisitor">PinArgVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.RenameLocalVisitor.html" title="struct rustc_mir_transform::coroutine::RenameLocalVisitor">RenameLocalVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.StateTransform.html" title="struct rustc_mir_transform::coroutine::StateTransform">StateTransform</a></div></li><li><div class="item-name"><a class="struct" href="struct.StorageConflictVisitor.html" title="struct rustc_mir_transform::coroutine::StorageConflictVisitor">StorageConflictVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.SuspendCheckData.html" title="struct rustc_mir_transform::coroutine::SuspendCheckData">SuspendCheckData</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.SuspensionPoint.html" title="struct rustc_mir_transform::coroutine::SuspensionPoint">SuspensionPoint</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">A <code>yield</code> point in the coroutine.</div></li><li><div class="item-name"><a class="struct" href="struct.TransformVisitor.html" title="struct rustc_mir_transform::coroutine::TransformVisitor">TransformVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Operation.html" title="enum rustc_mir_transform::coroutine::Operation">Operation</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">An operation that can be performed on a coroutine.</div></li></ul><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.POISONED.html" title="constant rustc_mir_transform::coroutine::POISONED">POISONED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Coroutine has panicked and is poisoned.</div></li><li><div class="item-name"><a class="constant" href="constant.RESERVED_VARIANTS.html" title="constant rustc_mir_transform::coroutine::RESERVED_VARIANTS">RESERVED_VARIANTS</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Number of reserved variants of coroutine state.</div></li><li><div class="item-name"><a class="constant" href="constant.RETURNED.html" title="constant rustc_mir_transform::coroutine::RETURNED">RETURNED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Coroutine has returned / is completed.</div></li><li><div class="item-name"><a class="constant" href="constant.SELF_ARG.html" title="constant rustc_mir_transform::coroutine::SELF_ARG">SELF_ARG</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.UNRESUMED.html" title="constant rustc_mir_transform::coroutine::UNRESUMED">UNRESUMED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Coroutine has not been resumed yet.</div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">Â§</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.can_return.html" title="fn rustc_mir_transform::coroutine::can_return">can_return</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.can_unwind.html" title="fn rustc_mir_transform::coroutine::can_unwind">can_unwind</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_field_tys_sized.html" title="fn rustc_mir_transform::coroutine::check_field_tys_sized">check_field_tys_sized</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_must_not_suspend_def.html" title="fn rustc_mir_transform::coroutine::check_must_not_suspend_def">check_must_not_suspend_def</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_must_not_suspend_ty.html" title="fn rustc_mir_transform::coroutine::check_must_not_suspend_ty">check_must_not_suspend_ty</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_suspend_tys.html" title="fn rustc_mir_transform::coroutine::check_suspend_tys">check_suspend_tys</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.compute_layout.html" title="fn rustc_mir_transform::coroutine::compute_layout">compute_layout</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.compute_storage_conflicts.html" title="fn rustc_mir_transform::coroutine::compute_storage_conflicts">compute_storage_conflicts</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">For every saved local, looks for which locals are StorageLive at the same
time. Generates a bitset for every local of all the other locals that may be
StorageLive simultaneously with that local. This is used in the layout
computation; see <code>CoroutineLayout</code> for more.</div></li><li><div class="item-name"><a class="fn" href="fn.create_cases.html" title="fn rustc_mir_transform::coroutine::create_cases">create_cases</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.create_coroutine_drop_shim.html" title="fn rustc_mir_transform::coroutine::create_coroutine_drop_shim">create_coroutine_drop_shim</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.create_coroutine_resume_function.html" title="fn rustc_mir_transform::coroutine::create_coroutine_resume_function">create_coroutine_resume_function</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.elaborate_coroutine_drops.html" title="fn rustc_mir_transform::coroutine::elaborate_coroutine_drops">elaborate_coroutine_drops</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.eliminate_get_context_call.html" title="fn rustc_mir_transform::coroutine::eliminate_get_context_call">eliminate_get_context_call</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.insert_clean_drop.html" title="fn rustc_mir_transform::coroutine::insert_clean_drop">insert_clean_drop</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.insert_panic_block.html" title="fn rustc_mir_transform::coroutine::insert_panic_block">insert_panic_block</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.insert_switch.html" title="fn rustc_mir_transform::coroutine::insert_switch">insert_switch</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Replaces the entry point of <code>body</code> with a block that switches on the coroutine discriminant and
dispatches to blocks according to <code>cases</code>.</div></li><li><div class="item-name"><a class="fn" href="fn.insert_term_block.html" title="fn rustc_mir_transform::coroutine::insert_term_block">insert_term_block</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.locals_live_across_suspend_points.html" title="fn rustc_mir_transform::coroutine::locals_live_across_suspend_points">locals_live_across_suspend_points</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Computes which locals have to be stored in the state-machine for the
given coroutine.</div></li><li><div class="item-name"><a class="fn" href="fn.make_coroutine_state_argument_indirect.html" title="fn rustc_mir_transform::coroutine::make_coroutine_state_argument_indirect">make_coroutine_state_argument_indirect</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.make_coroutine_state_argument_pinned.html" title="fn rustc_mir_transform::coroutine::make_coroutine_state_argument_pinned">make_coroutine_state_argument_pinned</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.mir_coroutine_witnesses.html" title="fn rustc_mir_transform::coroutine::mir_coroutine_witnesses">mir_coroutine_witnesses</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.replace_base.html" title="fn rustc_mir_transform::coroutine::replace_base">replace_base</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.replace_local.html" title="fn rustc_mir_transform::coroutine::replace_local">replace_local</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Allocates a new local and replaces all references of <code>local</code> with it. Returns the new local.</div></li><li><div class="item-name"><a class="fn" href="fn.replace_resume_ty_local.html" title="fn rustc_mir_transform::coroutine::replace_resume_ty_local">replace_resume_ty_local</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.transform_async_context.html" title="fn rustc_mir_transform::coroutine::transform_async_context">transform_async_context</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Transforms the <code>body</code> of the coroutine applying the following transforms:</div></li><li><div class="item-name"><a class="fn" href="fn.transform_gen_context.html" title="fn rustc_mir_transform::coroutine::transform_gen_context">transform_gen_context</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Transforms the <code>body</code> of the coroutine applying the following transform:</div></li></ul></section></div></main></body></html>